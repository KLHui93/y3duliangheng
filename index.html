<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三年级度量衡换算练习题</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* A4 paper print settings, 1cm margin */
        @page {
            size: A4 landscape;
            margin: 1cm;
        }

        /* General body styles */
        body {
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
        }

        /* Control panel styles */
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        .controls label, .controls input, .controls button {
            font-size: 16px;
            font-weight: 500;
        }
        .controls input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            text-align: center;
        }
        .controls button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .controls #generateBtn {
            background-color: #3b82f6;
        }
        .controls #generateBtn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .controls #printBtn {
            background-color: #9ca3af;
        }
        .controls #printBtn:hover {
            background-color: #6b7280;
            transform: translateY(-2px);
        }

        .controls #checkBtn {
            background-color: #10b981;
        }
        .controls #checkBtn:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }

        .controls #generateImageBtn {
            background-color: #f59e0b; /* A distinct color for the new button */
        }
        .controls #generateImageBtn:hover {
            background-color: #d97706;
            transform: translateY(-2px);
        }

        /* Page header for printing */
        .page-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
        }

        .result-summary {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        /* Container for all problems */
        .problems-container {
            column-count: 3;
            column-gap: 30px;
        }

        /* Individual problem item styles */
        .problem-item {
            font-size: 18px; /* Increased font size */
            margin-bottom: 15px;
            break-inside: avoid-column; /* Prevents problem from being split across columns */
        }
        .problem-item input {
            width: 80px; /* Increased input width to match font size */
            padding: 4px;
            border: 1px solid #ccc; /* Grid-like border */
            border-radius: 4px;
            font-size: 18px; /* Increased font size */
            text-align: center;
            background: transparent;
        }

        .problem-item input.correct {
            border-color: #10b981;
            background-color: #e0f2f1;
        }
        
        .problem-item input.incorrect {
            border-color: #ef4444;
            background-color: #fee2e2;
        }
        
        .problem-item span {
            font-weight: bold;
            margin-right: 5px;
        }

        /* Styles for printing */
        @media print {
            body {
                padding: 0;
                background-color: #fff;
            }
            .controls, .page-break, .result-summary {
                display: none;
            }
            .problems-container {
                column-count: 3;
                column-gap: 20px;
                display: block; /* Ensures column layout is applied correctly */
            }
            .problem-item {
                margin-bottom: 10px; /* Reduced margin for tighter packing */
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <label for="numProblems">生成题数：</label>
        <input type="number" id="numProblems" value="60" min="1" max="200">
        <button id="generateBtn" onclick="generateProblems()">生成题目</button>
        <button id="checkBtn" onclick="checkAnswers()">检查答案</button>
        <button id="generateImageBtn" onclick="generateImage()">生成图片</button>
        <button id="printBtn" onclick="window.print()">打印 (PDF)</button>
    </div>

    <div id="pageContent" class="page-content">
        <div class="page-header">三年级度量衡换算练习题</div>
        <div id="resultSummary" class="result-summary" style="display: none;"></div>
        <div class="problems-container" id="problemsContainer"></div>
    </div>

    <script>
        /**
         * Generates a specified number of unique random measurement conversion problems.
         */
        function generateProblems() {
            const numProblems = document.getElementById('numProblems').value;
            const container = document.getElementById('problemsContainer');
            container.innerHTML = ''; // Clear existing problems
            document.getElementById('resultSummary').style.display = 'none';

            // A Set to store unique problem keys to prevent duplicates
            const generatedProblems = new Set();
            let problemCount = 0;

            // Loop until the desired number of unique problems are generated
            while (problemCount < numProblems) {
                // Array of all possible problem types, including new mixed unit conversion types
                const problemTypes = [
                    'kg_g', 'g_kg', 'kg_g_mix_g', 'g_kg_mix_kg_g',
                    'l_ml', 'ml_l', 'l_ml_mix_ml', 'ml_l_mix_l_ml',
                    'm_cm', 'cm_m', 'm_cm_mix_cm', 'cm_m_mix_m_cm'
                ];

                const type = problemTypes[Math.floor(Math.random() * problemTypes.length)];
                let problem = '';
                let problemKey = type;
                let answer = {};

                // Generate problem content and a unique key based on the type and values
                switch (type) {
                    case 'kg_g':
                        const kgVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${kgVal1} 公斤 = <input type="text" class="answer-box" data-answer-type="g"> 克`;
                        problemKey += `_${kgVal1}`;
                        answer = { g: kgVal1 * 1000 };
                        break;
                    case 'g_kg':
                        const gVal1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                        problem = `${gVal1} 克 = <input type="text" class="answer-box" data-answer-type="kg"> 公斤`;
                        problemKey += `_${gVal1}`;
                        answer = { kg: gVal1 / 1000 };
                        break;
                    case 'kg_g_mix_g':
                        const kgVal2 = Math.floor(Math.random() * 10) + 1;
                        const gVal2 = (Math.floor(Math.random() * 99) + 1) * 10;
                        problem = `${kgVal2} 公斤 ${gVal2} 克 = <input type="text" class="answer-box" data-answer-type="g"> 克`;
                        problemKey += `_${kgVal2}_${gVal2}`;
                        answer = { g: (kgVal2 * 1000) + gVal2 };
                        break;
                    case 'g_kg_mix_kg_g':
                        const kgVal3 = Math.floor(Math.random() * 10) + 1;
                        const gVal3 = (Math.floor(Math.random() * 99) + 1) * 10;
                        const totalGrams = (kgVal3 * 1000) + gVal3;
                        problem = `${totalGrams} 克 = <input type="text" class="answer-box" data-answer-type="kg"> 公斤 <input type="text" class="answer-box" data-answer-type="g"> 克`;
                        problemKey += `_${totalGrams}`;
                        answer = { kg: kgVal3, g: gVal3 };
                        break;
                    case 'l_ml':
                        const lVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${lVal1} 升 = <input type="text" class="answer-box" data-answer-type="ml"> 毫升`;
                        problemKey += `_${lVal1}`;
                        answer = { ml: lVal1 * 1000 };
                        break;
                    case 'ml_l':
                        const mlVal1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                        problem = `${mlVal1} 毫升 = <input type="text" class="answer-box" data-answer-type="l"> 升`;
                        problemKey += `_${mlVal1}`;
                        answer = { l: mlVal1 / 1000 };
                        break;
                    case 'l_ml_mix_ml':
                        const lVal2 = Math.floor(Math.random() * 10) + 1;
                        const mlVal2 = (Math.floor(Math.random() * 99) + 1) * 10;
                        problem = `${lVal2} 升 ${mlVal2} 毫升 = <input type="text" class="answer-box" data-answer-type="ml"> 毫升`;
                        problemKey += `_${lVal2}_${mlVal2}`;
                        answer = { ml: (lVal2 * 1000) + mlVal2 };
                        break;
                    case 'ml_l_mix_l_ml':
                        const lVal3 = Math.floor(Math.random() * 10) + 1;
                        const mlVal3 = (Math.floor(Math.random() * 99) + 1) * 10;
                        const totalMilliliters = (lVal3 * 1000) + mlVal3;
                        problem = `${totalMilliliters} 毫升 = <input type="text" class="answer-box" data-answer-type="l"> 升 <input type="text" class="answer-box" data-answer-type="ml"> 毫升`;
                        problemKey += `_${totalMilliliters}`;
                        answer = { l: lVal3, ml: mlVal3 };
                        break;
                    case 'm_cm':
                        const mVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${mVal1} 米 = <input type="text" class="answer-box" data-answer-type="cm"> 厘米`;
                        problemKey += `_${mVal1}`;
                        answer = { cm: mVal1 * 100 };
                        break;
                    case 'cm_m':
                        const cmVal1 = (Math.floor(Math.random() * 10) + 1) * 100;
                        problem = `${cmVal1} 厘米 = <input type="text" class="answer-box" data-answer-type="m"> 米`;
                        problemKey += `_${cmVal1}`;
                        answer = { m: cmVal1 / 100 };
                        break;
                    case 'm_cm_mix_cm':
                        const mVal2 = Math.floor(Math.random() * 10) + 1;
                        const cmVal2 = (Math.floor(Math.random() * 9) + 1) * 10;
                        problem = `${mVal2} 米 ${cmVal2} 厘米 = <input type="text" class="answer-box" data-answer-type="cm"> 厘米`;
                        problemKey += `_${mVal2}_${cmVal2}`;
                        answer = { cm: (mVal2 * 100) + cmVal2 };
                        break;
                    case 'cm_m_mix_m_cm':
                        const mVal3 = Math.floor(Math.random() * 10) + 1;
                        const cmVal3 = (Math.floor(Math.random() * 9) + 1) * 10;
                        const totalCentimeters = (mVal3 * 100) + cmVal3;
                        problem = `${totalCentimeters} 厘米 = <input type="text" class="answer-box" data-answer-type="m"> 米 <input type="text" class="answer-box" data-answer-type="cm"> 厘米`;
                        problemKey += `_${totalCentimeters}`;
                        answer = { m: mVal3, cm: cmVal3 };
                        break;
                }

                // Check if this problem is unique. If not, try again in the next loop iteration.
                if (!generatedProblems.has(problemKey)) {
                    generatedProblems.add(problemKey);
                    
                    const problemItem = document.createElement('div');
                    problemItem.className = 'problem-item';
                    problemItem.innerHTML = `<span>${problemCount + 1}.</span> ${problem}`;
                    
                    // Store the correct answers in data attributes
                    for (const type in answer) {
                        const input = problemItem.querySelector(`[data-answer-type="${type}"]`);
                        if (input) {
                            input.setAttribute('data-answer', answer[type]);
                        }
                    }

                    container.appendChild(problemItem);
                    problemCount++;
                }
            }
        }

        /**
         * Checks the user's answers and provides visual feedback.
         * It only checks input fields that are not empty.
         */
        function checkAnswers() {
            const problems = document.querySelectorAll('.problem-item');
            let correctCount = 0;
            let checkedProblemsCount = 0;

            problems.forEach(problem => {
                const inputs = problem.querySelectorAll('.answer-box');
                let allCorrectForProblem = true;
                let hasAnswer = false;

                inputs.forEach(input => {
                    const userAnswer = input.value.trim();
                    const correctAnswer = input.getAttribute('data-answer');

                    // If the input is empty, skip checking it and leave its state unchanged
                    if (userAnswer === '') {
                        return;
                    }
                    
                    hasAnswer = true;
                    
                    // Reset classes before checking
                    input.classList.remove('correct', 'incorrect');
                    
                    if (userAnswer === String(correctAnswer)) {
                        input.classList.add('correct');
                    } else {
                        input.classList.add('incorrect');
                        allCorrectForProblem = false;
                    }
                });

                if (hasAnswer) {
                    checkedProblemsCount++;
                    if (allCorrectForProblem) {
                        correctCount++;
                    }
                }
            });

            const summary = document.getElementById('resultSummary');
            if (checkedProblemsCount > 0) {
                summary.textContent = `你答对了 ${correctCount} 题，总共 ${checkedProblemsCount} 题。`;
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        /**
         * Generates and downloads a PNG image of the content.
         */
        function generateImage() {
            // Target the main content area to be captured
            const pageContent = document.getElementById('pageContent');
            
            // Check if there is content to capture
            if (pageContent.children.length <= 1) { // 1 child is the header
                alert('请先生成题目和作答，再生成图片。');
                return;
            }

            // Temporarily hide the buttons for a cleaner image
            const controls = document.querySelector('.controls');
            controls.style.display = 'none';
            
            // Use html2canvas to render the content as a canvas
            html2canvas(pageContent, { scale: 2, useCORS: true }).then(canvas => {
                // Restore the buttons
                controls.style.display = 'flex';

                // Get the image data as a URL
                const imageDataUrl = canvas.toDataURL('image/png');
                
                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = '度量衡练习题-结果.png';
                
                // Append the link to the body and click it to trigger download
                document.body.appendChild(link);
                link.click();
                
                // Clean up the temporary link element
                document.body.removeChild(link);
            }).catch(error => {
                // Restore the buttons in case of an error
                controls.style.display = 'flex';
                console.error('An error occurred while generating the image:', error);
                alert('生成图片时出错，请重试。');
            });
        }
        
        // This function is no longer needed since a better method is provided.
        // It's commented out to prevent confusion.
        // function emailResults() {
        //     alert('此功能已被更好的“生成图片”功能取代。请点击生成图片，再手动附加到邮件发送。');
        // }

        // Generate problems on page load for immediate use
        document.addEventListener('DOMContentLoaded', generateProblems);
    </script>

</body>
</html>
