<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三年级度量衡换算练习题</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Google Fonts for a better look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* A4 paper print settings, 1cm margin */
        @page {
            size: A4 landscape;
            margin: 1cm;
        }

        /* General body styles */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #e2e8f0; /* A slightly more pleasant background color */
        }

        /* Control panel styles */
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Stronger shadow for depth */
            flex-wrap: wrap;
        }
        .controls label, .controls input, .controls button {
            font-size: 16px;
            font-weight: 500;
        }
        .controls input[type="number"], .controls input[type="text"] {
            width: 120px; /* Wider input fields */
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            text-align: center;
            transition: all 0.3s ease;
        }
        .controls input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5);
        }
        .controls button {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .controls button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .controls #generateBtn {
            background-color: #3b82f6;
        }
        .controls #generateBtn:active {
            background-color: #2563eb;
            transform: translateY(0);
        }

        .controls #printBtn {
            background-color: #6b7280;
        }
        .controls #printBtn:active {
            background-color: #4b5563;
            transform: translateY(0);
        }

        .controls #checkBtn {
            background-color: #10b981;
        }
        .controls #checkBtn:active {
            background-color: #059669;
            transform: translateY(0);
        }

        .controls #generateImageBtn {
            background-color: #f59e0b;
        }
        .controls #generateImageBtn:active {
            background-color: #d97706;
            transform: translateY(0);
        }

        /* Page header and info bar styles */
        .page-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .info-bar {
            background-color: #ffffff;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-summary {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1f2937;
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Container for all problems */
        .problems-container {
            column-count: 3;
            column-gap: 30px;
        }

        /* Individual problem item styles */
        .problem-item {
            font-size: 20px; /* Increased font size */
            margin-bottom: 18px;
            break-inside: avoid-column;
        }
        .problem-item input {
            width: 80px;
            padding: 6px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .problem-item input.correct {
            border-color: #10b981;
            background-color: #e0f2f1;
            animation: pulseCorrect 0.5s ease-in-out;
        }
        
        .problem-item input.incorrect {
            border-color: #ef4444;
            background-color: #fee2e2;
            animation: shake 0.3s ease-in-out;
        }
        
        .problem-item span {
            font-weight: bold;
            margin-right: 5px;
        }

        /* Copyright info styles */
        .copyright-info {
            font-size: 14px;
            color: #6b7280;
            margin-top: 2rem;
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid #d1d5db;
        }

        /* Keyframe animations for visual feedback */
        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styles for printing */
        @media print {
            body {
                padding: 0;
                background-color: #fff;
            }
            .controls, .page-break, .result-summary {
                display: none;
            }
            .problems-container {
                column-count: 3;
                column-gap: 20px;
                display: block;
            }
            .problem-item {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <label for="numProblems">生成题数：</label>
        <input type="number" id="numProblems" value="60" min="1" max="200">
        <label for="studentName">学生姓名：</label>
        <input type="text" id="studentName" placeholder="在此输入你的名字">
        <button id="generateBtn" onclick="generateProblems()">生成题目</button>
        <button id="checkBtn" onclick="checkAllAnswers()">检查所有答案</button>
        <button id="generateImageBtn" onclick="generateImage()">生成图片</button>
        <button id="printBtn" onclick="window.print()">打印 (PDF)</button>
    </div>

    <div id="pageContent" class="page-content">
        <div class="page-header">三年级度量衡换算练习题</div>
        <div class="info-bar">
            <div id="studentNameDisplay">姓名：</div>
            <div id="currentDate"></div>
        </div>
        <div id="resultSummary" class="result-summary" style="display: none;"></div>
        <div class="problems-container" id="problemsContainer"></div>
        <div class="copyright-info">
            <p>许峵育老师 巴音新村华文小学</p>
        </div>
    </div>

    <script>
        // Use Web Audio API for simple sound generation without external files
        let audioContext;

        /**
         * Plays a sound for a correct answer.
         */
        function playCorrectSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.value = 880; // A higher pitch for correct
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

            // Fade out the sound to avoid a harsh click
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        /**
         * Plays a sound for an incorrect answer.
         */
        function playIncorrectSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.value = 220; // A lower pitch for incorrect
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

            // Fade out the sound
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        /**
         * Generates a specified number of unique random measurement conversion problems.
         */
        function generateProblems() {
            const numProblems = document.getElementById('numProblems').value;
            const container = document.getElementById('problemsContainer');
            container.innerHTML = ''; // Clear existing problems
            document.getElementById('resultSummary').style.display = 'none';

            // A Set to store unique problem keys to prevent duplicates
            const generatedProblems = new Set();
            let problemCount = 0;

            // Loop until the desired number of unique problems are generated
            while (problemCount < numProblems) {
                // Array of all possible problem types, including new mixed unit conversion types
                const problemTypes = [
                    'kg_g', 'g_kg', 'kg_g_mix_g', 'g_kg_mix_kg_g',
                    'l_ml', 'ml_l', 'l_ml_mix_ml', 'ml_l_mix_l_ml',
                    'm_cm', 'cm_m', 'm_cm_mix_cm', 'cm_m_mix_m_cm'
                ];

                const type = problemTypes[Math.floor(Math.random() * problemTypes.length)];
                let problem = '';
                let problemKey = type;
                let answer = {};

                // Generate problem content and a unique key based on the type and values
                switch (type) {
                    case 'kg_g':
                        const kgVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${kgVal1} 公斤 = <input type="text" class="answer-box" data-answer-type="g" oninput="checkSingleAnswer(this)"> 克`;
                        problemKey += `_${kgVal1}`;
                        answer = { g: kgVal1 * 1000 };
                        break;
                    case 'g_kg':
                        const gVal1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                        problem = `${gVal1} 克 = <input type="text" class="answer-box" data-answer-type="kg" oninput="checkSingleAnswer(this)"> 公斤`;
                        problemKey += `_${gVal1}`;
                        answer = { kg: gVal1 / 1000 };
                        break;
                    case 'kg_g_mix_g':
                        const kgVal2 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 999 for grams, to allow for cases with a zero
                        const gVal2 = Math.floor(Math.random() * 999) + 1;
                        problem = `${kgVal2} 公斤 ${gVal2} 克 = <input type="text" class="answer-box" data-answer-type="g" oninput="checkSingleAnswer(this)"> 克`;
                        problemKey += `_${kgVal2}_${gVal2}`;
                        answer = { g: (kgVal2 * 1000) + gVal2 };
                        break;
                    case 'g_kg_mix_kg_g':
                        const kgVal3 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 999 for grams, to allow for cases with a zero
                        const gVal3 = Math.floor(Math.random() * 999) + 1;
                        const totalGrams = (kgVal3 * 1000) + gVal3;
                        problem = `${totalGrams} 克 = <input type="text" class="answer-box" data-answer-type="kg" oninput="checkSingleAnswer(this)"> 公斤 <input type="text" class="answer-box" data-answer-type="g" oninput="checkSingleAnswer(this)"> 克`;
                        problemKey += `_${totalGrams}`;
                        answer = { kg: kgVal3, g: gVal3 };
                        break;
                    case 'l_ml':
                        const lVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${lVal1} 升 = <input type="text" class="answer-box" data-answer-type="ml" oninput="checkSingleAnswer(this)"> 毫升`;
                        problemKey += `_${lVal1}`;
                        answer = { ml: lVal1 * 1000 };
                        break;
                    case 'ml_l':
                        const mlVal1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                        problem = `${mlVal1} 毫升 = <input type="text" class="answer-box" data-answer-type="l" oninput="checkSingleAnswer(this)"> 升`;
                        problemKey += `_${mlVal1}`;
                        answer = { l: mlVal1 / 1000 };
                        break;
                    case 'l_ml_mix_ml':
                        const lVal2 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 999 for milliliters, to allow for cases with a zero
                        const mlVal2 = Math.floor(Math.random() * 999) + 1;
                        problem = `${lVal2} 升 ${mlVal2} 毫升 = <input type="text" class="answer-box" data-answer-type="ml" oninput="checkSingleAnswer(this)"> 毫升`;
                        problemKey += `_${lVal2}_${mlVal2}`;
                        answer = { ml: (lVal2 * 1000) + mlVal2 };
                        break;
                    case 'ml_l_mix_l_ml':
                        const lVal3 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 999 for milliliters, to allow for cases with a zero
                        const mlVal3 = Math.floor(Math.random() * 999) + 1;
                        const totalMilliliters = (lVal3 * 1000) + mlVal3;
                        problem = `${totalMilliliters} 毫升 = <input type="text" class="answer-box" data-answer-type="l" oninput="checkSingleAnswer(this)"> 升 <input type="text" class="answer-box" data-answer-type="ml" oninput="checkSingleAnswer(this)"> 毫升`;
                        problemKey += `_${totalMilliliters}`;
                        answer = { l: lVal3, ml: mlVal3 };
                        break;
                    case 'm_cm':
                        const mVal1 = Math.floor(Math.random() * 10) + 1;
                        problem = `${mVal1} 米 = <input type="text" class="answer-box" data-answer-type="cm" oninput="checkSingleAnswer(this)"> 厘米`;
                        problemKey += `_${mVal1}`;
                        answer = { cm: mVal1 * 100 };
                        break;
                    case 'cm_m':
                        const cmVal1 = (Math.floor(Math.random() * 10) + 1) * 100;
                        problem = `${cmVal1} 厘米 = <input type="text" class="answer-box" data-answer-type="m" oninput="checkSingleAnswer(this)"> 米`;
                        problemKey += `_${cmVal1}`;
                        answer = { m: cmVal1 / 100 };
                        break;
                    case 'm_cm_mix_cm':
                        const mVal2 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 99 for centimeters, to allow for cases with a zero
                        const cmVal2 = Math.floor(Math.random() * 99) + 1;
                        problem = `${mVal2} 米 ${cmVal2} 厘米 = <input type="text" class="answer-box" data-answer-type="cm" oninput="checkSingleAnswer(this)"> 厘米`;
                        problemKey += `_${mVal2}_${cmVal2}`;
                        answer = { cm: (mVal2 * 100) + cmVal2 };
                        break;
                    case 'cm_m_mix_m_cm':
                        const mVal3 = Math.floor(Math.random() * 10) + 1;
                        // Generate a random number from 1 to 99 for centimeters, to allow for cases with a zero
                        const cmVal3 = Math.floor(Math.random() * 99) + 1;
                        const totalCentimeters = (mVal3 * 100) + cmVal3;
                        problem = `${totalCentimeters} 厘米 = <input type="text" class="answer-box" data-answer-type="m" oninput="checkSingleAnswer(this)"> 米 <input type="text" class="answer-box" data-answer-type="cm" oninput="checkSingleAnswer(this)"> 厘米`;
                        problemKey += `_${totalCentimeters}`;
                        answer = { m: mVal3, cm: cmVal3 };
                        break;
                }

                // Check if this problem is unique. If not, try again in the next loop iteration.
                if (!generatedProblems.has(problemKey)) {
                    generatedProblems.add(problemKey);
                    
                    const problemItem = document.createElement('div');
                    problemItem.className = 'problem-item';
                    problemItem.innerHTML = `<span>${problemCount + 1}.</span> ${problem}`;
                    
                    // Store the correct answers in data attributes
                    for (const type in answer) {
                        const input = problemItem.querySelector(`[data-answer-type="${type}"]`);
                        if (input) {
                            input.setAttribute('data-answer', answer[type]);
                        }
                    }

                    container.appendChild(problemItem);
                    problemCount++;
                }
            }
        }

        /**
         * Checks a single input field's answer and provides immediate feedback.
         * @param {HTMLInputElement} inputElement The input element to check.
         */
        function checkSingleAnswer(inputElement) {
            const userAnswer = inputElement.value.trim();
            const correctAnswer = inputElement.getAttribute('data-answer');

            // Do nothing if the input is empty
            if (userAnswer === '') {
                inputElement.classList.remove('correct', 'incorrect');
                return;
            }

            // Remove previous feedback classes
            inputElement.classList.remove('correct', 'incorrect');

            if (userAnswer === String(correctAnswer)) {
                inputElement.classList.add('correct');
                playCorrectSound();
            } else {
                inputElement.classList.add('incorrect');
                playIncorrectSound();
            }
        }

        /**
         * Checks all user's answers and provides a summary.
         */
        function checkAllAnswers() {
            const problems = document.querySelectorAll('.problem-item');
            let correctCount = 0;
            let checkedProblemsCount = 0;
            let hasIncorrectAnswer = false;

            problems.forEach(problem => {
                const inputs = problem.querySelectorAll('.answer-box');
                let allCorrectForProblem = true;
                let hasAnswer = false;

                inputs.forEach(input => {
                    const userAnswer = input.value.trim();
                    const correctAnswer = input.getAttribute('data-answer');
                    
                    if (userAnswer === '') {
                        return;
                    }
                    hasAnswer = true;
                    
                    // Real-time check already handles visual feedback
                    if (userAnswer !== String(correctAnswer)) {
                        allCorrectForProblem = false;
                        hasIncorrectAnswer = true;
                    }
                });

                if (hasAnswer) {
                    checkedProblemsCount++;
                    if (allCorrectForProblem) {
                        correctCount++;
                    }
                }
            });

            // Play sound based on overall result
            if (checkedProblemsCount > 0) {
                if (hasIncorrectAnswer) {
                    playIncorrectSound();
                } else {
                    playCorrectSound();
                }
            }
            
            const summary = document.getElementById('resultSummary');
            if (checkedProblemsCount > 0) {
                summary.textContent = `你答对了 ${correctCount} 题，总共 ${checkedProblemsCount} 题。`;
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        /**
         * Generates and downloads a PNG image of the content.
         */
        function generateImage() {
            // Target the main content area to be captured
            const pageContent = document.getElementById('pageContent');
            
            // Check if there is content to capture
            if (pageContent.children.length <= 1) { // 1 child is the header
                alert('请先生成题目和作答，再生成图片。');
                return;
            }

            // Temporarily hide the buttons for a cleaner image
            const controls = document.querySelector('.controls');
            controls.style.display = 'none';
            
            // Use html2canvas to render the content as a canvas
            html2canvas(pageContent, { scale: 2, useCORS: true }).then(canvas => {
                // Restore the buttons
                controls.style.display = 'flex';

                // Get the image data as a URL
                const imageDataUrl = canvas.toDataURL('image/png');
                
                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = imageDataUrl;
                
                // Get the student's name for the filename
                const studentName = document.getElementById('studentName').value.trim();
                const fileName = studentName ? `度量衡练习题-${studentName}-结果.png` : '度量衡练习题-结果.png';
                link.download = fileName;
                
                // Append the link to the body and click it to trigger download
                document.body.appendChild(link);
                link.click();
                
                // Clean up the temporary link element
                document.body.removeChild(link);
            }).catch(error => {
                // Restore the buttons in case of an error
                controls.style.display = 'flex';
                console.error('An error occurred while generating the image:', error);
                alert('生成图片时出错，请重试。');
            });
        }
        
        /**
         * Updates the student's name and the current date on the page.
         */
        function updateInfoBar() {
            const studentNameInput = document.getElementById('studentName');
            const studentNameDisplay = document.getElementById('studentNameDisplay');
            const currentDateElement = document.getElementById('currentDate');

            // Update name display based on input
            studentNameInput.addEventListener('input', () => {
                const name = studentNameInput.value.trim();
                studentNameDisplay.textContent = name ? `姓名：${name}` : '姓名：';
            });
            
            // Format and display the current date
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            currentDateElement.textContent = `日期：${year}年${month}月${day}日`;
        }

        // Generate problems and update the info bar on page load for immediate use
        document.addEventListener('DOMContentLoaded', () => {
            generateProblems();
            updateInfoBar();
        });
    </script>

</body>
</html>
